name: Merge All Reports

on:
  workflow_dispatch:

jobs:
  merge-and-report:
    runs-on: ubuntu-latest
    env:
      ANDROID_RUN_ID: 21401187889
      ANDROID_ARTIFACT: android-serenity-json
      IOS_RUN_ID: 21401691295
      IOS_ARTIFACT: ios-serenity-json

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Android Serenity JSON
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/$ANDROID_RUN_ID/artifacts > android_artifacts.json
          ARTIFACT_ID=$(jq -r --arg NAME "$ANDROID_ARTIFACT" '.artifacts[] | select(.name==$NAME) | .id' android_artifacts.json)
          [ -z "$ARTIFACT_ID" ] && echo "Android JSON artifact not found!" && exit 1
          curl -L -H "Authorization: Bearer $GITHUB_TOKEN" \
            -o android_json.zip \
            https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip
          unzip android_json.zip -d android-json

      - name: Download iOS Serenity JSON
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/$IOS_RUN_ID/artifacts > ios_artifacts.json
          ARTIFACT_ID=$(jq -r --arg NAME "$IOS_ARTIFACT" '.artifacts[] | select(.name==$NAME) | .id' ios_artifacts.json)
          [ -z "$ARTIFACT_ID" ] && echo "iOS JSON artifact not found!" && exit 1
          curl -L -H "Authorization: Bearer $GITHUB_TOKEN" \
            -o ios_json.zip \
            https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip
          unzip ios_json.zip -d ios-json

      - name: Merge Serenity JSONs
        run: |
          mkdir merged-json
          find android-json -type f -name '*.json' -exec cp {} merged-json/ \;
          find ios-json -type f -name '*.json' -exec cp {} merged-json/ \;

      - name: List merged-json content
        run: |
          ls -l merged-json
          head -n 20 merged-json/*.json || true

      - name: Generate Merged Serenity HTML Report
        run: mvn serenity:aggregate -Dserenity.sourceDirectory=merged-json -Dserenity.outputDirectory=merged-html-report

      - name: Replace Serenity Core CSS
        if: always()
        run: |
          REPORT_DIR="merged-html-report"
          echo "Replacing core.css using custom-style.css..."
          mkdir -p "$REPORT_DIR/css"
          cp src/test/resources/custom-style.css "$REPORT_DIR/css/core.css"

      - name: Upload Merged HTML Serenity Report
        uses: actions/upload-artifact@v4
        with:
          name: merged-serenity-html
          path: serenity-report
